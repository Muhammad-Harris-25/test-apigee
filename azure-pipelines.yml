trigger:
  branches:
    include:
      - dev
      - uat
      - prod
  paths:
    exclude:
      - README.md
      - shared-pom.xml
      - apigeelint-pr.yml
      - azure-pipelines.yml
      - scripts/**

variables:
  - ${{ if eq( variables['Build.SourceBranch'], 'refs/heads/prod' ) }}:
      - group: Apigee-Prod
  - ${{ if eq( variables['Build.SourceBranch'], 'refs/heads/uat' ) }}:
      - group: Apigee-Uat
  - ${{ if eq( variables['Build.SourceBranch'], 'refs/heads/dev' ) }}:
      - group: Apigee-Dev

pool:
  vmImage: ubuntu-latest

steps:

# ==========================================================
# 0Ô∏è‚É£ CHECKOUT
# ==========================================================
- checkout: self
  fetchDepth: 0

# ==========================================================
# 1Ô∏è‚É£ DETECT CHANGED PROXIES
# ==========================================================
- bash: |
    echo "üîç Detecting changed proxies..."

    BASE=$(git rev-parse HEAD~1 2>/dev/null || git rev-list --max-parents=0 HEAD)

    CHANGED=$(git diff --name-only $BASE HEAD \
      | grep '^api-proxies/' \
      | cut -d'/' -f2 \
      | sort -u)

    if [ -z "$CHANGED" ]; then
      echo "‚ùå No proxy changes detected"
      exit 1
    fi

    echo ""
    echo "‚úÖ Detected Proxies:"
    echo "$CHANGED"

    # convert newline ‚Üí space for later steps
    CHANGED_SPACES=$(echo "$CHANGED" | tr '\n' ' ')

    echo "##vso[task.setvariable variable=CHANGED_PROXIES]$CHANGED_SPACES"
  displayName: "Detect Changed Proxies"

# ==========================================================
# 2Ô∏è‚É£ DOWNLOAD SERVICE ACCOUNT
# ==========================================================
- task: DownloadSecureFile@1
  name: serviceAccountKey
  inputs:
    secureFile: $(SERVICE_ACCOUNT_FILE)
  displayName: "Download Service Account"

# ==========================================================
# 3Ô∏è‚É£ GENERATE ACCESS TOKEN (ONCE)
# ==========================================================
- bash: |
    chmod +x scripts/revision.sh

    FIRST_PROXY=$(echo "$(CHANGED_PROXIES)" | awk '{print $1}')

    OUTPUT=$(scripts/revision.sh \
      "$(ORG)" \
      "$FIRST_PROXY" \
      "$(APIGEE_ENVIRONMENT)" \
      "$(serviceAccountKey.secureFilePath)")

    TOKEN=$(echo "$OUTPUT" | grep -oP '(?<=variable=access_token;isOutput=true\]).*')

    if [ -z "$TOKEN" ]; then
      echo "‚ùå Token generation failed"
      exit 1
    fi

    echo "##vso[task.setvariable variable=ACCESS_TOKEN]$TOKEN"
  displayName: "Generate Access Token"

# ==========================================================
# 4Ô∏è‚É£ LINT + DEPLOY + INTEGRATION (PER PROXY)
# ==========================================================
- bash: |
    npm install -g apigeelint newman newman-reporter-html
    mkdir -p reports

    SUCCESS=""
    FAILED_LINT=""
    FAILED_DEPLOY=""
    FAILED_INTEGRATION=""

    IFS=' ' read -r -a PROXIES <<< "$(CHANGED_PROXIES)"

    for proxy in "${PROXIES[@]}"; do

      echo ""
      echo "==============================================="
      echo "üö¶ PROCESSING: $proxy"
      echo "==============================================="

      PROXY_DIR="$(Build.SourcesDirectory)/api-proxies/$proxy/apiproxy"
      POM_FILE="$(Build.SourcesDirectory)/api-proxies/$proxy/pom.xml"
      TEST_FILE="$(Build.SourcesDirectory)/api-proxies/$proxy/tests/integration/PassCollection.json"
      REPORT_DIR="reports/$proxy"

      mkdir -p "$REPORT_DIR"

      # ---------- LINT ----------
      echo "üîß LINTING"
      LINT=$(apigeelint -s "$PROXY_DIR" -f table.js --profile apigeex)
      echo "$LINT"
      apigeelint -s "$PROXY_DIR" -f html.js --profile apigeex > "$REPORT_DIR/lint.html"

      if echo "$LINT" | grep -q "error"; then
        echo "‚ùå LINT FAILED"
        FAILED_LINT="$FAILED_LINT $proxy"
        continue
      fi

      # ---------- DEPLOY ----------
      echo "üöÄ DEPLOYING"
      mvn clean install \
        -f "$POM_FILE" \
        -P$(APIGEE_ENVIRONMENT) \
        -Dorg=$(ORG) \
        -Dbearer=$(ACCESS_TOKEN)

      if [ $? -ne 0 ]; then
        echo "‚ùå DEPLOY FAILED"
        FAILED_DEPLOY="$FAILED_DEPLOY $proxy"
        continue
      fi

      # ---------- INTEGRATION ----------
      if [ ! -f "$TEST_FILE" ]; then
        echo "‚ö†Ô∏è PassCollection.json not found ‚Äì skipping integration"
        SUCCESS="$SUCCESS $proxy"
        continue
      fi

      echo "üß™ RUNNING INTEGRATION: PassCollection.json"
      newman run "$TEST_FILE" \
        --reporters cli,html \
        --reporter-html-export "$REPORT_DIR/integration.html"

      if [ $? -ne 0 ]; then
        echo "‚ùå INTEGRATION FAILED"
        FAILED_INTEGRATION="$FAILED_INTEGRATION $proxy"
        continue
      fi

      echo "‚úÖ ALL STEPS PASSED"
      SUCCESS="$SUCCESS $proxy"

    done

    echo "##vso[task.setvariable variable=SUCCESS_LIST]$SUCCESS"
    echo "##vso[task.setvariable variable=FAILED_LINT]$FAILED_LINT"
    echo "##vso[task.setvariable variable=FAILED_DEPLOY]$FAILED_DEPLOY"
    echo "##vso[task.setvariable variable=FAILED_INTEGRATION]$FAILED_INTEGRATION"
  displayName: "Lint + Deploy + Integration (Enterprise Standard)"

# ==========================================================
# 5Ô∏è‚É£ PUBLISH REPORTS
# ==========================================================
- publish: reports
  artifact: proxy-reports
  displayName: "Publish Reports"
  condition: always()

# ==========================================================
# 6Ô∏è‚É£ FINAL SUMMARY
# ==========================================================
- bash: |
    echo ""
    echo "============================================"
    echo "üöÄ FINAL PIPELINE SUMMARY"
    echo "============================================"
    echo ""
    echo "‚úÖ SUCCESS:"
    echo "$(SUCCESS_LIST)"
    echo ""
    echo "‚ùå LINT FAILED:"
    echo "$(FAILED_LINT)"
    echo ""
    echo "‚ùå DEPLOY FAILED:"
    echo "$(FAILED_DEPLOY)"
    echo ""
    echo "‚ùå INTEGRATION FAILED:"
    echo "$(FAILED_INTEGRATION)"
  displayName: "Final Summary"
  condition: always()

