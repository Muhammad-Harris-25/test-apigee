name: Apigee CI/CD Pipeline

on:
  push:
    branches:
      - dev
      - uat
      - prod
    paths-ignore:
      - README.md
      - shared-pom.xml
      - apigeelint-pr.yml
      - azure-pipelines.yml
      - scripts/**
  workflow_dispatch:

env:
  NODE_VERSION: 18

jobs:
  apigee:
    runs-on: ubuntu-latest

    steps:
      # ==========================================================
      # 0Ô∏è‚É£ CHECKOUT
      # ==========================================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ==========================================================
      # 1Ô∏è‚É£ DETECT CHANGED PROXIES
      # ==========================================================
      - name: Detect changed proxies
        id: detect
        shell: bash
        run: |
          echo "üîç Detecting changed proxies..."

          BASE=$(git rev-parse HEAD~1 2>/dev/null || git rev-list --max-parents=0 HEAD)

          CHANGED=$(git diff --name-only $BASE HEAD \
            | grep '^api-proxies/' \
            | cut -d'/' -f2 \
            | sort -u)

          if [ -z "$CHANGED" ]; then
            echo "‚ùå No proxy changes detected"
            exit 1
          fi

          echo "‚úÖ Detected proxies:"
          echo "$CHANGED"

          CHANGED_SPACES=$(echo "$CHANGED" | tr '\n' ' ')
          echo "changed_proxies=$CHANGED_SPACES" >> $GITHUB_OUTPUT

      # ==========================================================
      # 2Ô∏è‚É£ SET ENV VARIABLES (DEV / UAT / PROD)
      # ==========================================================
      - name: Set environment variables
        shell: bash
        run: |
          BRANCH=${GITHUB_REF##*/}

          if [ "$BRANCH" = "prod" ]; then
            echo "APIGEE_ENVIRONMENT=prod" >> $GITHUB_ENV
            echo "ORG=${{ secrets.APIGEE_PROD_ORG }}" >> $GITHUB_ENV
            echo "SERVICE_ACCOUNT=${{ secrets.APIGEE_PROD_SA }}" >> $GITHUB_ENV
          elif [ "$BRANCH" = "uat" ]; then
            echo "APIGEE_ENVIRONMENT=uat" >> $GITHUB_ENV
            echo "ORG=${{ secrets.APIGEE_UAT_ORG }}" >> $GITHUB_ENV
            echo "SERVICE_ACCOUNT=${{ secrets.APIGEE_UAT_SA }}" >> $GITHUB_ENV
          else
            echo "APIGEE_ENVIRONMENT=dev" >> $GITHUB_ENV
            echo "ORG=${{ secrets.APIGEE_DEV_ORG }}" >> $GITHUB_ENV
            echo "SERVICE_ACCOUNT=${{ secrets.APIGEE_DEV_SA }}" >> $GITHUB_ENV
          fi

      # ==========================================================
      # 3Ô∏è‚É£ SETUP TOOLS
      # ==========================================================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 11

      - name: Install tools
        run: |
          npm install -g apigeelint newman newman-reporter-html

      # ==========================================================
      # 4Ô∏è‚É£ GENERATE ACCESS TOKEN
      # ==========================================================
      - name: Generate access token
        id: token
        shell: bash
        run: |
          chmod +x scripts/revision.sh

          FIRST_PROXY=$(echo "${{ steps.detect.outputs.changed_proxies }}" | awk '{print $1}')

          OUTPUT=$(scripts/revision.sh \
            "$ORG" \
            "$FIRST_PROXY" \
            "$APIGEE_ENVIRONMENT" \
            "$SERVICE_ACCOUNT")

          TOKEN=$(echo "$OUTPUT" | grep -oP '(?<=access_token=).*')

          if [ -z "$TOKEN" ]; then
            echo "‚ùå Token generation failed"
            exit 1
          fi

          echo "ACCESS_TOKEN=$TOKEN" >> $GITHUB_ENV

      # ==========================================================
      # 5Ô∏è‚É£ LINT + DEPLOY + INTEGRATION
      # ==========================================================
      - name: Lint, Deploy & Integration Test
        shell: bash
        run: |
          mkdir -p reports

          SUCCESS=""
          FAILED_LINT=""
          FAILED_DEPLOY=""
          FAILED_INTEGRATION=""

          IFS=' ' read -r -a PROXIES <<< "${{ steps.detect.outputs.changed_proxies }}"

          for proxy in "${PROXIES[@]}"; do
            echo "===================================="
            echo "üö¶ Processing $proxy"
            echo "===================================="

            PROXY_DIR="api-proxies/$proxy/apiproxy"
            POM_FILE="api-proxies/$proxy/pom.xml"
            TEST_FILE="api-proxies/$proxy/tests/integration/PassCollection.json"
            REPORT_DIR="reports/$proxy"

            mkdir -p "$REPORT_DIR"

            # ---------- LINT ----------
            LINT=$(apigeelint -s "$PROXY_DIR" -f table.js --profile apigeex)
            apigeelint -s "$PROXY_DIR" -f html.js --profile apigeex > "$REPORT_DIR/lint.html"

            if echo "$LINT" | grep -q "error"; then
              FAILED_LINT="$FAILED_LINT $proxy"
              continue
            fi

            # ---------- DEPLOY ----------
            mvn clean install \
              -f "$POM_FILE" \
              -P$APIGEE_ENVIRONMENT \
              -Dorg=$ORG \
              -Dbearer=$ACCESS_TOKEN

            if [ $? -ne 0 ]; then
              FAILED_DEPLOY="$FAILED_DEPLOY $proxy"
              continue
            fi

            # ---------- INTEGRATION ----------
            if [ -f "$TEST_FILE" ]; then
              newman run "$TEST_FILE" \
                --reporters cli,html \
                --reporter-html-export "$REPORT_DIR/integration.html"

              if [ $? -ne 0 ]; then
                FAILED_INTEGRATION="$FAILED_INTEGRATION $proxy"
                continue
              fi
            fi

            SUCCESS="$SUCCESS $proxy"
          done

          echo "SUCCESS=$SUCCESS" >> $GITHUB_ENV
          echo "FAILED_LINT=$FAILED_LINT" >> $GITHUB_ENV
          echo "FAILED_DEPLOY=$FAILED_DEPLOY" >> $GITHUB_ENV
          echo "FAILED_INTEGRATION=$FAILED_INTEGRATION" >> $GITHUB_ENV

      # ==========================================================
      # 6Ô∏è‚É£ UPLOAD REPORTS
      # ==========================================================
      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: proxy-reports
          path: reports
        if: always()

      # ==========================================================
      # 7Ô∏è‚É£ FINAL SUMMARY
      # ==========================================================
      - name: Final summary
        if: always()
        run: |
          echo "‚úÖ SUCCESS: $SUCCESS"
          echo "‚ùå LINT FAILED: $FAILED_LINT"
          echo "‚ùå DEPLOY FAILED: $FAILED_DEPLOY"
          echo "‚ùå INTEGRATION FAILED: $FAILED_INTEGRATION"
