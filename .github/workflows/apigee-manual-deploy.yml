name: Apigee - Manual Deploy

on:
  workflow_run:
    workflows: ["Apigee - Detect Changed Proxies"]
    types: [completed]

  workflow_dispatch:
    inputs:
      proxies:
        description: "Comma-separated proxy names OR type ALL"
        required: true

env:
  NODE_VERSION: 18

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download detected proxies artifact
        uses: actions/download-artifact@v4
        with:
          name: detected-proxies
          run-id: ${{ github.event.workflow_run.id }}

      - name: Load detected proxies
        shell: bash
        run: |
          DETECTED=$(tr '\n' ' ' < detected_proxies.txt)
          echo "DETECTED_PROXIES=$DETECTED" >> $GITHUB_ENV

          echo "Detected proxies:"
          cat detected_proxies.txt

      - name: Resolve selected proxies
        shell: bash
        run: |
          INPUT="${{ github.event.inputs.proxies }}"
          DETECTED="$DETECTED_PROXIES"

          if [ "$INPUT" = "ALL" ]; then
            SELECTED="$DETECTED"
          else
            SELECTED=""
            IFS=',' read -r -a USER <<< "$INPUT"
            for p in "${USER[@]}"; do
              p=$(echo "$p" | xargs)
              if ! echo "$DETECTED" | grep -qw "$p"; then
                echo "âŒ Invalid proxy: $p"
                exit 1
              fi
              SELECTED="$SELECTED $p"
            done
          fi

          echo "SELECTED_PROXIES=$SELECTED" >> $GITHUB_ENV
          echo "Using proxies: $SELECTED"

      # ===== Your existing Apigee setup steps go here =====
      # Node / Java / secrets / service account / token etc.

      - name: Deploy selected proxies
        shell: bash
        run: |
          for proxy in $SELECTED_PROXIES; do
            echo "ðŸš€ Deploying $proxy"

            apigeelint -s api-proxies/$proxy/apiproxy

            mvn clean install \
              -f api-proxies/$proxy/pom.xml \
              -P$APIGEE_ENVIRONMENT \
              -Dorg=$ORG \
              -Dbearer=$ACCESS_TOKEN

            if [ -f api-proxies/$proxy/tests/integration/PassCollection.json ]; then
              newman run api-proxies/$proxy/tests/integration/PassCollection.json
            fi
          done

      - name: Final Summary
        if: always()
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed Proxies:**" >> $GITHUB_STEP_SUMMARY
          for p in $SELECTED_PROXIES; do
            echo "- $p" >> $GITHUB_STEP_SUMMARY
          done
