name: Apigee - Manual Deploy Proxies

on:
  workflow_dispatch:
    inputs:
      deploy_mode:
        description: "Choose deployment mode"
        required: true
        default: manual
        type: choice
        options:
          - manual
          - random
      proxies:
        description: "Comma-separated proxy names (required if manual)"
        required: false

env:
  NODE_VERSION: 18

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # =========================
      # CHECKOUT
      # =========================
      - uses: actions/checkout@v4

      # =========================
      # DOWNLOAD DETECTED PROXIES
      # =========================
      - uses: actions/download-artifact@v4
        with:
          name: detected-proxies

      - name: Load detected proxies
        shell: bash
        run: |
          if [ ! -f detected_proxies.txt ]; then
            echo "‚ùå detected_proxies.txt not found"
            exit 1
          fi

          DETECTED=$(cat detected_proxies.txt)
          echo "Detected proxies:"
          echo "$DETECTED"

          echo "DETECTED=$DETECTED" >> $GITHUB_ENV

      # =========================
      # SELECT PROXIES
      # =========================
      - name: Select target proxies
        shell: bash
        run: |
          MODE="${{ github.event.inputs.deploy_mode }}"

          if [ "$MODE" = "random" ]; then
            IFS=$'\n' read -r -d '' -a ARR <<< "$DETECTED"$'\0'
            SELECTED=${ARR[$RANDOM % ${#ARR[@]}]}
            echo "üéØ Randomly selected: $SELECTED"

          else
            if [ -z "${{ github.event.inputs.proxies }}" ]; then
              echo "‚ùå proxies input required for manual mode"
              exit 1
            fi

            IFS=',' read -r -a USER <<< "${{ github.event.inputs.proxies }}"
            for p in "${USER[@]}"; do
              p=$(echo "$p" | xargs)
              if ! echo "$DETECTED" | grep -qw "$p"; then
                echo "‚ùå Invalid proxy: $p"
                exit 1
              fi
              SELECTED="$SELECTED $p"
            done
          fi

          echo "TARGET_PROXIES=$SELECTED" >> $GITHUB_ENV

      # =========================
      # LOAD APIGEE VARIABLES
      # =========================
      - name: Load Apigee variables
        run: |
          echo "ORG=${{ vars.ORG }}" >> $GITHUB_ENV
          echo "APIGEE_ENVIRONMENT=${{ vars.APIGEE_ENVIRONMENT }}" >> $GITHUB_ENV
          echo "SERVICE_ACCOUNT_FILE=${{ vars.SERVICE_ACCOUNT_FILE }}" >> $GITHUB_ENV

      # =========================
      # CREATE SERVICE ACCOUNT FILE
      # =========================
      - name: Create service account file
        run: |
          echo "${{ secrets.SECUREFILE }}" | base64 --decode > "$SERVICE_ACCOUNT_FILE"
          chmod 600 "$SERVICE_ACCOUNT_FILE"

      # =========================
      # SETUP TOOLS
      # =========================
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 11

      - name: Install tools
        run: npm install -g apigeelint newman newman-reporter-html

      # =========================
      # GENERATE ACCESS TOKEN
      # =========================
      - name: Generate access token
        shell: bash
        run: |
          chmod +x scripts/revision.sh
          FIRST=$(echo "$TARGET_PROXIES" | awk '{print $1}')

          OUTPUT=$(scripts/revision.sh \
            "$ORG" \
            "$FIRST" \
            "$APIGEE_ENVIRONMENT" \
            "$SERVICE_ACCOUNT_FILE" 2>&1)

          TOKEN=$(echo "$OUTPUT" | sed -n 's/.*variable=access_token;isOutput=true]\(.*\)/\1/p')

          if [ -z "$TOKEN" ]; then
            echo "‚ùå Token generation failed"
            exit 1
          fi

          echo "ACCESS_TOKEN=$TOKEN" >> $GITHUB_ENV

      # =========================
      # LINT + DEPLOY + TEST
      # =========================
      - name: Lint, Deploy & Integration
        shell: bash
        run: |
          SUCCESS=""
          FAILED=""
          HAS_FAILURE=0

          for proxy in $TARGET_PROXIES; do
            echo "üöÄ Processing $proxy"

            apigeelint -s api-proxies/$proxy/apiproxy || { FAILED="$FAILED $proxy"; HAS_FAILURE=1; continue; }

            mvn clean install \
              -f api-proxies/$proxy/pom.xml \
              -P$APIGEE_ENVIRONMENT \
              -Dorg=$ORG \
              -Dbearer=$ACCESS_TOKEN || { FAILED="$FAILED $proxy"; HAS_FAILURE=1; continue; }

            if [ -f api-proxies/$proxy/tests/integration/PassCollection.json ]; then
              newman run api-proxies/$proxy/tests/integration/PassCollection.json || { FAILED="$FAILED $proxy"; HAS_FAILURE=1; }
            fi

            SUCCESS="$SUCCESS $proxy"
          done

          echo "SUCCESS=$SUCCESS" >> $GITHUB_ENV
          echo "FAILED=$FAILED" >> $GITHUB_ENV

          [ $HAS_FAILURE -eq 1 ] && exit 1

      # =========================
      # FINAL SUMMARY
      # =========================
      - name: Final Summary
        if: always()
        run: |
          echo "=============================="
          echo "üöÄ FINAL SUMMARY"
          echo "=============================="
          echo "‚úÖ SUCCESS: ${SUCCESS:-None}"
          echo "‚ùå FAILED: ${FAILED:-None}"

          