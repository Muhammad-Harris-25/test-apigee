name: Apigee - Manual Deploy Selected Proxies

on:
  workflow_dispatch:
    inputs:
      proxies:
        description: "Copy proxy names from the Detect workflow summary (comma-separated)"
        required: true

env:
  NODE_VERSION: 18

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # ==============================
      # CHECKOUT
      # ==============================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ==============================
      # LOAD VARIABLES
      # ==============================
      - name: Load Apigee variables
        shell: bash
        run: |
          echo "ORG=${{ vars.ORG }}" >> $GITHUB_ENV
          echo "APIGEE_ENVIRONMENT=${{ vars.APIGEE_ENVIRONMENT }}" >> $GITHUB_ENV
          echo "SERVICE_ACCOUNT_FILE=${{ vars.SERVICE_ACCOUNT_FILE }}" >> $GITHUB_ENV

      # ==============================
      # CREATE SERVICE ACCOUNT FILE
      # ==============================
      - name: Create service account file
        shell: bash
        run: |
          echo "${{ secrets.SECUREFILE }}" | base64 --decode > "$SERVICE_ACCOUNT_FILE"
          chmod 600 "$SERVICE_ACCOUNT_FILE"

      # ==============================
      # VALIDATE SELECTED PROXIES
      # ==============================
      - name: Validate selected proxies
        shell: bash
        run: |
          DETECTED=$(ls api-proxies | sort)
          IFS=',' read -r -a SELECTED <<< "${{ github.event.inputs.proxies }}"

          echo "Detected proxies:"
          echo "$DETECTED"
          echo ""
          echo "Selected proxies:"
          printf '%s\n' "${SELECTED[@]}"

          for p in "${SELECTED[@]}"; do
            p=$(echo "$p" | xargs)
            if ! echo "$DETECTED" | grep -qw "$p"; then
              echo "‚ùå Invalid proxy selected: $p"
              exit 1
            fi
          done

          echo "VALID_PROXIES=$(echo "${SELECTED[*]}")" >> $GITHUB_ENV
          echo "‚úÖ Proxy selection validated"

      # ==============================
      # SETUP TOOLS
      # ==============================
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 11

      - name: Install tools
        run: |
          npm install -g apigeelint newman newman-reporter-html

      # ==============================
      # GENERATE ACCESS TOKEN
      # ==============================
      - name: Generate access token
        shell: bash
        run: |
          chmod +x scripts/revision.sh

          FIRST_PROXY=$(echo "$VALID_PROXIES" | awk '{print $1}')

          OUTPUT=$(scripts/revision.sh \
            "$ORG" \
            "$FIRST_PROXY" \
            "$APIGEE_ENVIRONMENT" \
            "$SERVICE_ACCOUNT_FILE" 2>&1)

          TOKEN=$(echo "$OUTPUT" \
            | sed -n 's/.*variable=access_token;isOutput=true]\(.*\)/\1/p')

          if [ -z "$TOKEN" ]; then
            echo "‚ùå Failed to get access token"
            exit 1
          fi

          echo "ACCESS_TOKEN=$TOKEN" >> $GITHUB_ENV

      # ==============================
      # LINT + DEPLOY + INTEGRATION
      # ==============================
      - name: Lint, Deploy & Integration
        shell: bash
        run: |
          mkdir -p reports

          SUCCESS=""
          FAILED_LINT=""
          FAILED_DEPLOY=""
          FAILED_INTEGRATION=""
          HAS_FAILURE=0

          IFS=' ' read -r -a PROXIES <<< "$VALID_PROXIES"

          for proxy in "${PROXIES[@]}"; do
            echo "===================================="
            echo "üö¶ Processing $proxy"
            echo "===================================="

            PROXY_DIR="api-proxies/$proxy/apiproxy"
            POM_FILE="api-proxies/$proxy/pom.xml"
            TEST_FILE="api-proxies/$proxy/tests/integration/PassCollection.json"

            apigeelint -s "$PROXY_DIR" -f table.js --profile apigeex
            if [ $? -ne 0 ]; then
              FAILED_LINT="$FAILED_LINT $proxy"
              HAS_FAILURE=1
              continue
            fi

            mvn clean install \
              -f "$POM_FILE" \
              -P$APIGEE_ENVIRONMENT \
              -Dorg=$ORG \
              -Dbearer=$ACCESS_TOKEN

            if [ $? -ne 0 ]; then
              FAILED_DEPLOY="$FAILED_DEPLOY $proxy"
              HAS_FAILURE=1
              continue
            fi

            if [ -f "$TEST_FILE" ]; then
              newman run "$TEST_FILE"
              if [ $? -ne 0 ]; then
                FAILED_INTEGRATION="$FAILED_INTEGRATION $proxy"
                HAS_FAILURE=1
                continue
              fi
            fi

            SUCCESS="$SUCCESS $proxy"
          done

          echo "SUCCESS=$SUCCESS" >> $GITHUB_ENV
          echo "FAILED_LINT=$FAILED_LINT" >> $GITHUB_ENV
          echo "FAILED_DEPLOY=$FAILED_DEPLOY" >> $GITHUB_ENV
          echo "FAILED_INTEGRATION=$FAILED_INTEGRATION" >> $GITHUB_ENV

          if [ $HAS_FAILURE -eq 1 ]; then
            exit 1
          fi

      # ==============================
      # FINAL SUMMARY
      # ==============================
      - name: Final Summary
        if: always()
        shell: bash
        run: |
          echo ""
          echo "======================================"
          echo "üöÄ FINAL PIPELINE SUMMARY"
          echo "======================================"
          echo ""
          echo "‚úÖ SUCCESS:"
          echo "${SUCCESS:-None}"
          echo ""
          echo "‚ùå LINT FAILED:"
          echo "${FAILED_LINT:-None}"
          echo ""
          echo "‚ùå DEPLOY FAILED:"
          echo "${FAILED_DEPLOY:-None}"
          echo ""
          echo "‚ùå INTEGRATION FAILED:"
          echo "${FAILED_INTEGRATION:-None}"
