name: Apigee - Manual Deploy

on:
  workflow_dispatch:
    inputs:
      proxies:
        description: "Type proxy names (comma-separated) OR ALL (see detected list in logs)"
        required: true

env:
  NODE_VERSION: 18

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # ==========================================================
      # 1Ô∏è‚É£ CHECKOUT REPOSITORY
      # ==========================================================
      - name: Checkout repository
        uses: actions/checkout@v4

      # ==========================================================
      # 2Ô∏è‚É£ SHOW DETECTED PROXIES FROM FILE
      # ==========================================================
      - name: Show detected proxies
        shell: bash
        run: |
          FILE=".github/detected_proxies.txt"

          if [ ! -f "$FILE" ]; then
            echo "‚ùå detected_proxies.txt not found in repo"
            echo "‚û°Ô∏è Run auto detect workflow first"
            exit 1
          fi

          if [ ! -s "$FILE" ]; then
            echo "‚ùå detected_proxies.txt is empty"
            exit 1
          fi

          echo ""
          echo "======================================"
          echo "üîç DETECTED APIGEE PROXIES"
          echo "======================================"
          cat "$FILE"
          echo ""
          echo "‚û°Ô∏è Copy proxy names into workflow input"
          echo "‚û°Ô∏è Or type ALL"

      # ==========================================================
      # 3Ô∏è‚É£ RESOLVE USER SELECTION
      # ==========================================================
      - name: Resolve selected proxies
        shell: bash
        run: |
          DETECTED=$(cat .github/detected_proxies.txt)
          INPUT="${{ github.event.inputs.proxies }}"

          if [ -z "$INPUT" ]; then
            echo "‚ùå No proxies input provided"
            exit 1
          fi

          if [ "$INPUT" = "ALL" ]; then
            SELECTED="$DETECTED"
          else
            SELECTED=""
            IFS=',' read -r -a USER <<< "$INPUT"

            for p in "${USER[@]}"; do
              p=$(echo "$p" | xargs)
              if ! echo "$DETECTED" | grep -qw "$p"; then
                echo "‚ùå Invalid proxy: $p"
                echo "Valid proxies are:"
                echo "$DETECTED"
                exit 1
              fi
              SELECTED="$SELECTED $p"
            done
          fi

          if [ -z "$SELECTED" ]; then
            echo "‚ùå No valid proxies selected"
            exit 1
          fi

          echo "SELECTED_PROXIES=$SELECTED" >> $GITHUB_ENV

          echo ""
          echo "‚úÖ Selected proxies:"
          for p in $SELECTED; do
            echo "- $p"
          done

      # ==========================================================
      # 4Ô∏è‚É£ SETUP NODE.JS
      # ==========================================================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # ==========================================================
      # 5Ô∏è‚É£ INSTALL APIGEE TOOLS
      # ==========================================================
      - name: Install Apigee tools
        shell: bash
        run: |
          npm install -g apigeelint newman newman-reporter-html

      # ==========================================================
      # 6Ô∏è‚É£ SETUP JAVA (MAVEN)
      # ==========================================================
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 11

      # ==========================================================
      # 7Ô∏è‚É£ LINT + DEPLOY + INTEGRATION
      # ==========================================================
      - name: Lint, Deploy & Integration
        shell: bash
        run: |
          for proxy in $SELECTED_PROXIES; do
            echo ""
            echo "üöÄ Processing proxy: $proxy"

            PROXY_DIR="api-proxies/$proxy/apiproxy"
            POM_FILE="api-proxies/$proxy/pom.xml"
            TEST_FILE="api-proxies/$proxy/tests/integration/PassCollection.json"

            # ---------- LINT ----------
            echo "üîç Linting $proxy"
            apigeelint -s "$PROXY_DIR" --profile apigeex

            # ---------- DEPLOY ----------
            echo "üöÄ Deploying $proxy"
            mvn clean install \
              -f "$POM_FILE" \
              -P$APIGEE_ENVIRONMENT \
              -Dorg=$ORG \
              -Dbearer=$ACCESS_TOKEN

            # ---------- INTEGRATION ----------
            if [ -f "$TEST_FILE" ]; then
              echo "üß™ Running integration tests for $proxy"
              newman run "$TEST_FILE"
            else
              echo "‚ö†Ô∏è No integration tests found for $proxy"
            fi
          done

      # ==========================================================
      # 8Ô∏è‚É£ FINAL SUMMARY
      # ==========================================================
      - name: Final Summary
        if: always()
        shell: bash
        run: |
          echo ""
          echo "======================================"
          echo "üöÄ MANUAL DEPLOY SUMMARY"
          echo "======================================"
          echo ""
          for p in $SELECTED_PROXIES; do
            echo "‚úÖ $p"
          done
