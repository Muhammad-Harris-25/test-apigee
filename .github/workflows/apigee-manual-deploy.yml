name: Apigee - Manual / Auto Deploy

on:
  workflow_dispatch:
    inputs:
      deploy_mode:
        description: "Deployment mode"
        required: true
        type: choice
        options:
          - auto
          - manual

      environment:
        description: "Target Apigee environment"
        required: true
        type: choice
        options:
          - dev
          - demo
          - uat
          - prod

      proxies:
        description: "Comma-separated proxy names (ONLY for manual mode)"
        required: false

env:
  NODE_VERSION: 18

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # ==========================================================
      # 0Ô∏è‚É£ CHECKOUT
      # ==========================================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ==========================================================
      # 1Ô∏è‚É£ SHOW DETECTED PROXIES
      # ==========================================================
      - name: Show detected proxies
        shell: bash
        run: |
          FILE=".github/detected_proxies.txt"

          if [ ! -f "$FILE" ]; then
            echo "‚ùå detected_proxies.txt not found"
            echo "‚û°Ô∏è Run auto-detect workflow first"
            exit 1
          fi

          if [ ! -s "$FILE" ]; then
            echo "‚ùå detected_proxies.txt is empty"
            exit 1
          fi

          echo "======================================"
          echo "üîç DETECTED APIGEE PROXIES"
          echo "======================================"
          cat "$FILE"
          echo ""

      # ==========================================================
      # 2Ô∏è‚É£ RESOLVE AUTO / MANUAL + ENV
      # ==========================================================
      - name: Resolve selected proxies
        shell: bash
        run: |
          MODE="${{ github.event.inputs.deploy_mode }}"
          ENV_INPUT="${{ github.event.inputs.environment }}"
          PROXY_INPUT="${{ github.event.inputs.proxies }}"
          FILE=".github/detected_proxies.txt"

          DETECTED=$(cat "$FILE")

          if [ "$MODE" = "auto" ]; then
            echo "üöÄ AUTO mode selected ‚Äî deploying ALL detected proxies"
            SELECTED="$DETECTED"

          elif [ "$MODE" = "manual" ]; then
            if [ -z "$PROXY_INPUT" ]; then
              echo "‚ùå Manual mode requires proxy names"
              exit 1
            fi

            SELECTED=""
            IFS=',' read -r -a USER <<< "$PROXY_INPUT"
            for p in "${USER[@]}"; do
              p=$(echo "$p" | xargs)
              if ! echo "$DETECTED" | grep -qw "$p"; then
                echo "‚ùå Invalid proxy: $p"
                exit 1
              fi
              SELECTED="$SELECTED $p"
            done
          else
            echo "‚ùå Unknown deploy mode"
            exit 1
          fi

          SELECTED=$(echo "$SELECTED" | xargs)

          if [ -z "$SELECTED" ]; then
            echo "‚ùå No proxies selected"
            exit 1
          fi

          echo "SELECTED_PROXIES=$SELECTED" >> $GITHUB_ENV
          echo "APIGEE_ENVIRONMENT=$ENV_INPUT" >> $GITHUB_ENV

          echo "======================================"
          echo "MODE : $MODE"
          echo "ENV  : $ENV_INPUT"
          echo "PROXIES:"
          for p in $SELECTED; do
            echo " - $p"
          done

      # ==========================================================
      # 3Ô∏è‚É£ LOAD APIGEE VARIABLES
      # ==========================================================
      - name: Load Apigee variables
        shell: bash
        run: |
          if [ -z "${{ vars.ORG }}" ] || [ -z "${{ vars.SERVICE_ACCOUNT_FILE }}" ]; then
            echo "‚ùå Required repo variables missing"
            exit 1
          fi

          echo "ORG=${{ vars.ORG }}" >> $GITHUB_ENV
          echo "SERVICE_ACCOUNT_FILE=${{ vars.SERVICE_ACCOUNT_FILE }}" >> $GITHUB_ENV

      # ==========================================================
      # 4Ô∏è‚É£ CREATE SERVICE ACCOUNT FILE
      # ==========================================================
      - name: Create service account file
        shell: bash
        run: |
          if [ -z "${{ secrets.SECUREFILE }}" ]; then
            echo "‚ùå SECUREFILE secret not set"
            exit 1
          fi

          echo "${{ secrets.SECUREFILE }}" | base64 --decode > "$SERVICE_ACCOUNT_FILE"
          chmod 600 "$SERVICE_ACCOUNT_FILE"

          echo "‚úÖ Service account file created"

      # ==========================================================
      # 5Ô∏è‚É£ SETUP TOOLS
      # ==========================================================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 11

      - name: Install tools
        shell: bash
        run: |
          npm install -g apigeelint newman newman-reporter-html

      # ==========================================================
      # 6Ô∏è‚É£ GENERATE ACCESS TOKEN
      # ==========================================================
      - name: Generate access token
        shell: bash
        run: |
          chmod +x scripts/revision.sh

          FIRST_PROXY=$(echo "$SELECTED_PROXIES" | awk '{print $1}')

          OUTPUT=$(scripts/revision.sh \
            "$ORG" \
            "$FIRST_PROXY" \
            "$APIGEE_ENVIRONMENT" \
            "$SERVICE_ACCOUNT_FILE" 2>&1)

          echo "$OUTPUT"

          TOKEN=$(echo "$OUTPUT" | grep -oE 'ya29\.[A-Za-z0-9._-]+')

          if [ -z "$TOKEN" ]; then
            echo "‚ùå Failed to extract access token"
            exit 1
          fi

          echo "ACCESS_TOKEN=$TOKEN" >> $GITHUB_ENV

      # ==========================================================
      # 7Ô∏è‚É£ LINT + DEPLOY + INTEGRATION
      # ==========================================================
      - name: Lint, Deploy & Integration
        shell: bash
        run: |
          SUCCESS=""
          FAILED=""
          HAS_FAILURE=0

          for proxy in $SELECTED_PROXIES; do
            echo "===================================="
            echo "üö¶ Processing $proxy"
            echo "===================================="

            PROXY_DIR="api-proxies/$proxy/apiproxy"
            POM_FILE="api-proxies/$proxy/pom.xml"
            TEST_FILE="api-proxies/$proxy/tests/integration/PassCollection.json"

            apigeelint -s "$PROXY_DIR" --profile apigeex || { FAILED="$FAILED $proxy"; HAS_FAILURE=1; continue; }

            mvn clean install \
              -f "$POM_FILE" \
              -P "$APIGEE_ENVIRONMENT" \
              -Dorg="$ORG" \
              -Dbearer="$ACCESS_TOKEN" || { FAILED="$FAILED $proxy"; HAS_FAILURE=1; continue; }

            if [ -f "$TEST_FILE" ]; then
              newman run "$TEST_FILE" || { FAILED="$FAILED $proxy"; HAS_FAILURE=1; continue; }
            fi

            SUCCESS="$SUCCESS $proxy"
          done

          echo "SUCCESS=$SUCCESS" >> $GITHUB_ENV
          echo "FAILED=$FAILED" >> $GITHUB_ENV

          if [ $HAS_FAILURE -eq 1 ]; then
            echo "‚ùå One or more proxies failed"
            exit 1
          fi

      # ==========================================================
      # 8Ô∏è‚É£ FINAL SUMMARY
      # ==========================================================
      - name: Final Summary
        if: always()
        shell: bash
        run: |
          echo "======================================"
          echo "üöÄ DEPLOYMENT SUMMARY"
          echo "======================================"
          echo ""
          echo "Environment: $APIGEE_ENVIRONMENT"
          echo ""
          echo "‚úÖ SUCCESS:"
          echo "${SUCCESS:-None}"
          echo ""
          echo "‚ùå FAILED:"
          echo "${FAILED:-None}"
