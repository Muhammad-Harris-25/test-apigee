name: Apigee - Enterprise Manual Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        type: choice
        options:
          - dev
          - demo
          - uat
          - prod

      proxy:
        description: "Proxy name to deploy OR ALL"
        required: true
        type: string

env:
  NODE_VERSION: 18

jobs:
  deploy:
    name: Deploy Apigee Proxies
    runs-on: ubuntu-latest

    # üîí Enable environment approvals (recommended for prod)
    environment:
      name: ${{ github.event.inputs.environment }}

    steps:
      # ==========================================================
      # 0Ô∏è‚É£ CHECKOUT
      # ==========================================================
      - name: Checkout repository
        uses: actions/checkout@v4

      # ==========================================================
      # 1Ô∏è‚É£ INVENTORY PROXIES (SOURCE OF TRUTH)
      # ==========================================================
      - name: Read proxies from api-proxies folder
        shell: bash
        run: |
          set -euo pipefail

          if [[ ! -d api-proxies ]]; then
            echo "‚ùå api-proxies folder not found"
            exit 1
          fi

          PROXIES=$(find api-proxies -maxdepth 1 -mindepth 1 -type d -printf "%f\n")

          if [[ -z "$PROXIES" ]]; then
            echo "‚ùå No proxies found in api-proxies"
            exit 1
          fi

          echo "AVAILABLE_PROXIES<<EOF" >> "$GITHUB_ENV"
          echo "$PROXIES" >> "$GITHUB_ENV"
          echo "EOF" >> "$GITHUB_ENV"

          echo "======================================"
          echo "üì¶ AVAILABLE APIGEE PROXIES"
          echo "======================================"
          echo "$PROXIES"
          echo ""

      # ==========================================================
      # 2Ô∏è‚É£ RESOLVE USER SELECTION (ENTERPRISE CHECKS)
      # ==========================================================
      - name: Resolve selected proxy
        shell: bash
        run: |
          set -euo pipefail

          INPUT="${{ github.event.inputs.proxy }}"
          PROXIES="$AVAILABLE_PROXIES"

          echo "======================================"
          echo "üßæ PROXY SELECTION VALIDATION"
          echo "======================================"
          echo "‚û°Ô∏è User input:"
          echo "   $INPUT"
          echo ""
          echo "üì¶ Available proxies:"
          echo "$PROXIES"
          echo "--------------------------------------"

          if [[ "$INPUT" == "ALL" ]]; then
            SELECTED="$PROXIES"
            echo "‚úÖ User selected ALL proxies"
          else
            if ! echo "$PROXIES" | grep -qx "$INPUT"; then
              echo "‚ùå Invalid proxy selection: $INPUT"
              echo ""
              echo "‚úÖ Allowed values:"
              echo "$PROXIES"
              echo ""
              echo "‚ÑπÔ∏è Tip: Use 'ALL' to deploy all proxies"
              exit 1
            fi

            SELECTED="$INPUT"
            echo "‚úÖ Valid proxy selected: $INPUT"
          fi

          echo "--------------------------------------"
          echo "üöÄ Proxies that will be deployed:"
          echo "$SELECTED"
          echo "======================================"

          echo "SELECTED_PROXIES<<EOF" >> "$GITHUB_ENV"
          echo "$SELECTED" >> "$GITHUB_ENV"
          echo "EOF" >> "$GITHUB_ENV"

      # ==========================================================
      # 3Ô∏è‚É£ LOAD APIGEE CONFIGURATION
      # ==========================================================
      - name: Load Apigee configuration
        shell: bash
        run: |
          set -euo pipefail

          ORG="${{ vars.ORG }}"
          APIGEE_ENVIRONMENT="${{ vars.APIGEE_ENVIRONMENT }}"
          SERVICE_ACCOUNT_FILE="${{ vars.SERVICE_ACCOUNT_FILE }}"

          [[ -z "$ORG" ]] && echo "‚ùå ORG variable missing" && exit 1
          [[ -z "$APIGEE_ENVIRONMENT" ]] && echo "‚ùå APIGEE_ENVIRONMENT variable missing" && exit 1
          [[ -z "$SERVICE_ACCOUNT_FILE" ]] && echo "‚ùå SERVICE_ACCOUNT_FILE variable missing" && exit 1

          echo "ORG=$ORG" >> "$GITHUB_ENV"
          echo "APIGEE_ENVIRONMENT=$APIGEE_ENVIRONMENT" >> "$GITHUB_ENV"
          echo "SERVICE_ACCOUNT_FILE=$SERVICE_ACCOUNT_FILE" >> "$GITHUB_ENV"

      # ==========================================================
      # 4Ô∏è‚É£ AUTHENTICATION
      # ==========================================================
      - name: Create service account file
        shell: bash
        run: |
          set -euo pipefail

          [[ -z "${{ secrets.SECUREFILE }}" ]] && echo "‚ùå SECUREFILE secret not set" && exit 1

          echo "${{ secrets.SECUREFILE }}" | base64 --decode > "$SERVICE_ACCOUNT_FILE"
          chmod 600 "$SERVICE_ACCOUNT_FILE"

          echo "üîê Service account file created"

      # ==========================================================
      # 5Ô∏è‚É£ TOOLCHAIN
      # ==========================================================
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 11

      - name: Install tools
        shell: bash
        run: |
          npm install -g apigeelint@2 newman@6

      # ==========================================================
      # 6Ô∏è‚É£ GENERATE ACCESS TOKEN (ONCE)
      # ==========================================================
      - name: Generate Apigee access token
        shell: bash
        run: |
          set -euo pipefail

          chmod +x scripts/revision.sh
          FIRST_PROXY=$(echo "$SELECTED_PROXIES" | head -n1)

          OUTPUT=$(scripts/revision.sh \
            "$ORG" \
            "$FIRST_PROXY" \
            "$APIGEE_ENVIRONMENT" \
            "$SERVICE_ACCOUNT_FILE" 2>&1)

          TOKEN=$(echo "$OUTPUT" | grep -oE 'ya29\.[A-Za-z0-9._-]+')

          [[ -z "$TOKEN" ]] && echo "‚ùå Failed to extract access token" && exit 1

          echo "ACCESS_TOKEN=$TOKEN" >> "$GITHUB_ENV"
          echo "‚úÖ Access token generated"

      # ==========================================================
      # 7Ô∏è‚É£ LINT ‚Üí DEPLOY ‚Üí TEST
      # ==========================================================
      - name: Lint, Deploy & Test
        shell: bash
        run: |
          set +e

          SUCCESS=()
          FAILED=()
          HAS_FAILURE=0

          while read -r proxy; do
            [[ -z "$proxy" ]] && continue

            echo "===================================="
            echo "üöÄ Processing proxy: $proxy"
            echo "===================================="

            BASE="api-proxies/$proxy"

            if [[ ! -d "$BASE/apiproxy" || ! -f "$BASE/pom.xml" ]]; then
              FAILED+=("$proxy")
              HAS_FAILURE=1
              continue
            fi

            apigeelint -s "$BASE/apiproxy" --profile apigeex || {
              FAILED+=("$proxy")
              HAS_FAILURE=1
              continue
            }

            mvn clean install -f "$BASE/pom.xml" \
              -P "$APIGEE_ENVIRONMENT" \
              -Dorg="$ORG" \
              -Dbearer="$ACCESS_TOKEN" || {
                FAILED+=("$proxy")
                HAS_FAILURE=1
                continue
              }

            TEST_FILE="$BASE/tests/integration/PassCollection.json"
            if [[ -f "$TEST_FILE" ]]; then
              newman run "$TEST_FILE" || {
                FAILED+=("$proxy")
                HAS_FAILURE=1
                continue
              }
            fi

            SUCCESS+=("$proxy")
          done <<< "$SELECTED_PROXIES"

          echo "SUCCESS=${SUCCESS[*]}" >> "$GITHUB_ENV"
          echo "FAILED=${FAILED[*]}" >> "$GITHUB_ENV"

          [[ $HAS_FAILURE -eq 1 ]] && exit 1 || exit 0

      # ==========================================================
      # 8Ô∏è‚É£ FINAL SUMMARY
      # ==========================================================
      - name: Deployment Summary
        if: always()
        shell: bash
        run: |
          echo "======================================"
          echo "üè¢ ENTERPRISE APIGEE DEPLOY SUMMARY"
          echo "======================================"
          echo "Environment : ${{ github.event.inputs.environment }}"
          echo "Organization: $ORG"
          echo ""
          echo "‚úÖ Successful:"
          echo "${SUCCESS:-None}"
          echo ""
          echo "‚ùå Failed:"
          echo "${FAILED:-None}"
