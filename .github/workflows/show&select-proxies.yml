name: Apigee - Enterprise Manual Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        type: choice
        options:
          - dev
          - uat
          - prod

      proxy:
        description: "Proxy name to deploy OR ALL"
        required: true
        type: string

env:
  NODE_VERSION: 18

jobs:
  deploy:
    name: Deploy Apigee Proxies
    runs-on: ubuntu-latest

    # üîí Environment protection (use approvals for prod)
    environment:
      name: ${{ github.event.inputs.environment }}

    steps:
      # ==========================================================
      # 0Ô∏è‚É£ CHECKOUT
      # ==========================================================
      - name: Checkout repository
        uses: actions/checkout@v4

      # ==========================================================
      # 1Ô∏è‚É£ INVENTORY PROXIES (SOURCE OF TRUTH)
      # ==========================================================
      - name: Read proxies from api-proxies folder
        shell: bash
        run: |
          set -euo pipefail

          if [[ ! -d api-proxies ]]; then
            echo "‚ùå api-proxies folder not found"
            exit 1
          fi

          PROXIES=$(find api-proxies -maxdepth 1 -mindepth 1 -type d -printf "%f\n")

          if [[ -z "$PROXIES" ]]; then
            echo "‚ùå No proxies found in api-proxies"
            exit 1
          fi

          echo "AVAILABLE_PROXIES<<EOF" >> "$GITHUB_ENV"
          echo "$PROXIES" >> "$GITHUB_ENV"
          echo "EOF" >> "$GITHUB_ENV"

          echo "üì¶ Available proxies:"
          echo "$PROXIES"

      # ==========================================================
      # 2Ô∏è‚É£ RESOLVE & VALIDATE USER SELECTION
      # ==========================================================
      - name: Resolve selected proxy
        shell: bash
        run: |
          set -euo pipefail

          INPUT="${{ github.event.inputs.proxy }}"
          PROXIES="$AVAILABLE_PROXIES"

          if [[ "$INPUT" == "ALL" ]]; then
            SELECTED="$PROXIES"
          else
            if ! echo "$PROXIES" | grep -qx "$INPUT"; then
              echo "‚ùå Invalid proxy selection: $INPUT"
              exit 1
            fi
            SELECTED="$INPUT"
          fi

          echo "SELECTED_PROXIES<<EOF" >> "$GITHUB_ENV"
          echo "$SELECTED" >> "$GITHUB_ENV"
          echo "EOF" >> "$GITHUB_ENV"

          echo "‚úÖ Selected proxies:"
          echo "$SELECTED"

      # ==========================================================
      # 3Ô∏è‚É£ LOAD ENV-SCOPED VARIABLES (SAFE)
      # ==========================================================
      - name: Load Apigee configuration
        shell: bash
        run: |
          set -euo pipefail

          ORG="${{ vars.ORG }}"
          APIGEE_ENVIRONMENT="${{ vars.APIGEE_ENVIRONMENT }}"
          SERVICE_ACCOUNT_FILE="${{ vars.SERVICE_ACCOUNT_FILE }}"

          if [[ -z "$ORG" ]]; then
            echo "‚ùå ORG variable missing"
            exit 1
          fi

          if [[ -z "$APIGEE_ENVIRONMENT" ]]; then
            echo "‚ùå APIGEE_ENVIRONMENT variable missing"
            exit 1
          fi

          if [[ -z "$SERVICE_ACCOUNT_FILE" ]]; then
            echo "‚ùå SERVICE_ACCOUNT_FILE variable missing"
            exit 1
          fi

          echo "ORG=$ORG" >> "$GITHUB_ENV"
          echo "APIGEE_ENVIRONMENT=$APIGEE_ENVIRONMENT" >> "$GITHUB_ENV"
          echo "SERVICE_ACCOUNT_FILE=$SERVICE_ACCOUNT_FILE" >> "$GITHUB_ENV"

      # ==========================================================
      # 4Ô∏è‚É£ AUTHENTICATION (SERVICE ACCOUNT)
      # ==========================================================
      - name: Create service account file
        shell: bash
        run: |
          set -euo pipefail

          if [[ -z "${{ secrets.SECUREFILE }}" ]]; then
            echo "‚ùå SECUREFILE secret not set"
            exit 1
          fi

          echo "${{ secrets.SECUREFILE }}" | base64 --decode > "$SERVICE_ACCOUNT_FILE"
          chmod 600 "$SERVICE_ACCOUNT_FILE"

          echo "üîê Service account file created"

      # ==========================================================
      # 5Ô∏è‚É£ TOOLCHAIN SETUP
      # ==========================================================
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 11

      - name: Install tools
        shell: bash
        run: |
          npm install -g apigeelint@2 newman@6

      # ==========================================================
      # 6Ô∏è‚É£ GENERATE ACCESS TOKEN (ONCE)
      # ==========================================================
      - name: Generate Apigee access token
        shell: bash
        run: |
          set -euo pipefail

          chmod +x scripts/revision.sh
          FIRST_PROXY=$(echo "$SELECTED_PROXIES" | head -n1)

          OUTPUT=$(scripts/revision.sh \
            "$ORG" \
            "$FIRST_PROXY" \
            "$APIGEE_ENVIRONMENT" \
            "$SERVICE_ACCOUNT_FILE" 2>&1)

          TOKEN=$(echo "$OUTPUT" | grep -oE 'ya29\.[A-Za-z0-9._-]+')

          if [[ -z "$TOKEN" ]]; then
            echo "‚ùå Failed to extract access token"
            exit 1
          fi

          echo "ACCESS_TOKEN=$TOKEN" >> "$GITHUB_ENV"
          echo "‚úÖ Access token generated"

      # ==========================================================
      # 7Ô∏è‚É£ LINT ‚Üí DEPLOY ‚Üí OPTIONAL TEST
      # ==========================================================
      - name: Lint, Deploy & Test
        shell: bash
        run: |
          set +e

          SUCCESS=()
          FAILED=()

          while read -r proxy; do
            echo "===================================="
            echo "üöÄ Processing proxy: $proxy"
            echo "===================================="

            BASE="api-proxies/$proxy"

            if [[ ! -d "$BASE/apiproxy" || ! -f "$BASE/pom.xml" ]]; then
              echo "‚ùå Invalid proxy structure: $proxy"
              FAILED+=("$proxy")
              continue
            fi

            echo "üßπ Linting..."
            apigeelint -s "$BASE/apiproxy" --profile apigeex || {
              FAILED+=("$proxy")
              continue
            }

            echo "üöÄ Deploying..."
            mvn clean install -f "$BASE/pom.xml" \
              -P "$APIGEE_ENVIRONMENT" \
              -Dorg="$ORG" \
              -Dbearer="$ACCESS_TOKEN" || {
                FAILED+=("$proxy")
                continue
              }

            TEST_FILE="$BASE/tests/integration/PassCollection.json"
            if [[ -f "$TEST_FILE" ]]; then
              echo "üß™ Running integration tests..."
              newman run "$TEST_FILE" || {
                FAILED+=("$proxy")
                continue
              }
            fi

            SUCCESS+=("$proxy")
          done <<< "$SELECTED_PROXIES"

          echo "SUCCESS=${SUCCESS[*]}" >> "$GITHUB_ENV"
          echo "FAILED=${FAILED[*]}" >> "$GITHUB_ENV"

          [[ ${#FAILED[@]} -gt 0 ]] && exit 1

      # ==========================================================
      # 8Ô∏è‚É£ FINAL SUMMARY
      # ==========================================================
      - name: Deployment Summary
        if: always()
        shell: bash
        run: |
          echo "======================================"
          echo "üè¢ ENTERPRISE APIGEE DEPLOY SUMMARY"
          echo "======================================"
          echo "Environment : ${{ github.event.inputs.environment }}"
          echo "Organization: $ORG"
          echo ""
          echo "‚úÖ Successful:"
          echo "${SUCCESS:-None}"
          echo ""
          echo "‚ùå Failed:"
          echo "${FAILED:-None}"
