name: Apigee - Detect Changed Proxies

on:
  push:
    branches: [dev, uat, prod]
    paths:
      - api-proxies/**

jobs:
  detect:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed proxies
        shell: bash
        run: |
          BASE=$(git rev-parse HEAD~1 2>/dev/null || git rev-list --max-parents=0 HEAD)

          CHANGED=$(git diff --name-only "$BASE" HEAD \
            | grep '^api-proxies/' \
            | cut -d'/' -f2 \
            | sort -u)

          if [ -z "$CHANGED" ]; then
            echo "No proxies detected"
            exit 0
          fi

          echo "$CHANGED" > detected_proxies.txt

      - name: Upload detected proxies
        uses: actions/upload-artifact@v4
        with:
          name: detected-proxies
          path: detected_proxies.txt

      - name: Job Summary
        run: |
          echo "## ðŸ” Detected Apigee Proxies" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          while read p; do
            echo "- $p" >> $GITHUB_STEP_SUMMARY
          done < detected_proxies.txt
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âž¡ï¸ Run **Apigee - Manual Deploy** workflow to deploy selected proxies" >> $GITHUB_STEP_SUMMARY
       