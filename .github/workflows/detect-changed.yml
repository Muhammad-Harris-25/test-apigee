name: Apigee - Detect Changed Proxies

on:
  push:
    branches: [ dev, uat, prod ]
    paths-ignore:
      - README.md
      - shared-pom.xml
      - apigeelint-pr.yml
      - azure-pipelines.yml
      - scripts/**

jobs:
  detect:
    runs-on: ubuntu-latest

    steps:
      # =========================
      # CHECKOUT
      # =========================
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # =========================
      # DETECT PROXIES
      # =========================
      - name: Detect changed proxies
        shell: bash
        run: |
          BASE=$(git rev-parse HEAD~1 2>/dev/null || git rev-list --max-parents=0 HEAD)

          CHANGED=$(git diff --name-only $BASE HEAD \
            | grep '^api-proxies/' \
            | cut -d'/' -f2 \
            | sort -u)

          if [ -z "$CHANGED" ]; then
            echo "No proxies detected"
            exit 0
          fi

          echo "$CHANGED" > detected_proxies.txt

          echo "## ðŸ” Detected Apigee Proxies" >> $GITHUB_STEP_SUMMARY
          for p in $CHANGED; do
            echo "- $p" >> $GITHUB_STEP_SUMMARY
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âž¡ï¸ Run **Apigee - Manual Deploy** workflow to deploy selected proxies" >> $GITHUB_STEP_SUMMARY

      # =========================
      # UPLOAD ARTIFACT
      # =========================
      - uses: actions/upload-artifact@v4
        with:
          name: detected-proxies
          path: detected_proxies.txt
