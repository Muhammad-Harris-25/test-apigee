name: Apigee - Detect Changed Proxies

on:
  push:
    branches: [ dev, uat, prod ]
    paths-ignore:
      - README.md
      - shared-pom.xml
      - apigeelint-pr.yml
      - azure-pipelines.yml
      - scripts/**

jobs:
  detect:
    runs-on: ubuntu-latest

    steps:
      # ==============================
      # CHECKOUT
      # ==============================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ==============================
      # DETECT PROXIES (FIXED)
      # ==============================
      - name: Detect changed proxies
        id: detect
        shell: bash
        run: |
          BASE=$(git rev-parse HEAD~1 2>/dev/null || git rev-list --max-parents=0 HEAD)

          CHANGED=$(git diff --name-only $BASE HEAD \
            | grep '^api-proxies/' \
            | cut -d'/' -f2 \
            | sort -u)

          # Convert newline â†’ space (IMPORTANT)
          CHANGED_SPACES=$(echo "$CHANGED" | tr '\n' ' ')

          echo "CHANGED=$CHANGED_SPACES" >> $GITHUB_ENV

          echo "======================================"
          echo "ðŸ” DETECTED APIGEE PROXIES"
          echo "======================================"

          if [ -z "$CHANGED" ]; then
            echo "âŒ No proxy changes detected"
          else
            for p in $CHANGED; do
              echo "ðŸ‘‰ $p"
            done
          fi

      # ==============================
      # PUBLISH SUMMARY (UI)
      # ==============================
      - name: Publish detected proxies (Summary)
        if: always()
        shell: bash
        run: |
          echo "## ðŸ” Detected Apigee Proxies" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -z "$CHANGED" ]; then
            echo "- None" >> $GITHUB_STEP_SUMMARY
          else
            for p in $CHANGED; do
              echo "- $p" >> $GITHUB_STEP_SUMMARY
            done
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**âž¡ï¸ Copy these proxy names and paste them into the Manual Deploy workflow input**" >> $GITHUB_STEP_SUMMARY
