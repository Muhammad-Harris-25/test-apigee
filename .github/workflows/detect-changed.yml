name: Apigee - Manual Deploy

on:
  workflow_dispatch:
    inputs:
      proxies:
        description: "Comma-separated proxy names OR ALL (see detected_proxies.txt)"
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Show detected proxies
        shell: bash
        run: |
          if [ ! -f .github/detected_proxies.txt ]; then
            echo "‚ùå detected_proxies.txt not found"
            exit 1
          fi

          echo "Detected proxies from last run:"
          cat .github/detected_proxies.txt

          echo ""
          echo "‚û°Ô∏è Copy names into workflow input"

      - name: Resolve selected proxies
        shell: bash
        run: |
          DETECTED=$(cat .github/detected_proxies.txt)
          INPUT="${{ github.event.inputs.proxies }}"

          if [ "$INPUT" = "ALL" ]; then
            SELECTED="$DETECTED"
          else
            SELECTED=""
            IFS=',' read -r -a USER <<< "$INPUT"
            for p in "${USER[@]}"; do
              p=$(echo "$p" | xargs)
              if ! echo "$DETECTED" | grep -qw "$p"; then
                echo "‚ùå Invalid proxy: $p"
                exit 1
              fi
              SELECTED="$SELECTED $p"
            done
          fi

          echo "SELECTED_PROXIES=$SELECTED" >> $GITHUB_ENV
          echo "Using proxies: $SELECTED"

      # üîΩ continue with lint / deploy / test
