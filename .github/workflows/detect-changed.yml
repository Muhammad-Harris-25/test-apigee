name: Apigee - Auto Deploy

on:
  push:
    branches: [dev, uat, prod]
    paths:
      - api-proxies/**

permissions:
  contents: write   # needed because detect workflow updates file

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # ==========================================================
      # 1ï¸âƒ£ CHECKOUT
      # ==========================================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ==========================================================
      # 2ï¸âƒ£ SHOW DETECTED PROXIES FROM FILE
      # ==========================================================
      - name: Show detected proxies
        shell: bash
        run: |
          FILE=".github/detected_proxies.txt"

          if [ ! -f "$FILE" ]; then
            echo "âŒ detected_proxies.txt not found in repo"
            exit 1
          fi

          echo ""
          echo "======================================"
          echo "ðŸ” DETECTED APIGEE PROXIES (AUTO)"
          echo "======================================"
          cat "$FILE"
          echo ""

      # ==========================================================
      # 3ï¸âƒ£ RESOLVE PROXIES (AUTO = ALL)
      # ==========================================================
      - name: Resolve proxies (auto mode)
        shell: bash
        run: |
          DETECTED=$(cat .github/detected_proxies.txt)

          if [ -z "$DETECTED" ]; then
            echo "âŒ No proxies detected"
            exit 1
          fi

          SELECTED="$DETECTED"

          echo "SELECTED_PROXIES=$SELECTED" >> $GITHUB_ENV
