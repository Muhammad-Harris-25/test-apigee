# =============================================================
# ðŸš€ Apigee Lint Validation on Pull Requests (Multi-Proxy)
# =============================================================

trigger: none   # âŒ Never run on push

pr:
  branches:
    include:
      - dev
      - uat
      - prod

pool:
  vmImage: 'ubuntu-latest'

steps:

# =============================================================
# 1ï¸âƒ£ Show PR Target Branch
# =============================================================
- bash: |
    echo "ðŸ” PR Target Branch: $(System.PullRequest.TargetBranch)"
    echo "ðŸ“‚ Repo root contents:"
    ls
  displayName: "Show PR Target Branch & Repo Root"

# =============================================================
# 2ï¸âƒ£ Apigee Lint â€“ ALL Proxies
# =============================================================
- bash: |
    echo "ðŸ“¦ Installing ApigeeLint..."
    npm install -g apigeelint
    apigeelint -V

    mkdir -p reports

    echo "ðŸ” Searching for Apigee proxies under api-proxies/..."
    PROXY_DIRS=$(find api-proxies -type d -name apiproxy)

    if [ -z "$PROXY_DIRS" ]; then
      echo "âŒ No apiproxy directories found under api-proxies/"
      exit 1
    fi

    > reports/table.txt
    > reports/index.html

    for proxy in $PROXY_DIRS; do
      PROXY_NAME=$(basename "$(dirname "$proxy")")
      echo "ðŸš€ Linting proxy: $PROXY_NAME"

      echo "==================== $PROXY_NAME ====================" >> reports/table.txt
      apigeelint -s "$proxy" -f table.js --profile apigeex >> reports/table.txt || true
      apigeelint -s "$proxy" -f html.js --profile apigeex >> reports/index.html || true
    done

    echo "ðŸŽ‰ Apigee Lint completed for all proxies"
  displayName: "Policy Code Analysis (Apigee Lint â€“ All Proxies)"

# =============================================================
# 3ï¸âƒ£ Publish Reports
# =============================================================
- publish: reports
  artifact: lint-report
  displayName: "Publish Apigee Lint Reports"
  condition: always()

# =============================================================
# 4ï¸âƒ£ Comment Results on PR
# =============================================================
- bash: |
    echo "ðŸ“ Posting lint summary to PR..."

    pr_id=$(System.PullRequest.PullRequestId)
    org_url="$(System.CollectionUri)"
    project="$(System.TeamProject)"
    repo_id="$(Build.Repository.ID)"
    build_id="$(Build.BuildId)"
    artifact_url="${org_url%/}/${project}/_build/results?buildId=${build_id}&view=artifacts"

    if [ -f "reports/index.html" ]; then
      status="âœ… **Apigee Lint completed** for **$(System.PullRequest.TargetBranch)**"
    else
      status="âš ï¸ **Apigee Lint report not generated**"
    fi

    lint_details=$(grep -E 'error|warning|âœ–|âš ' reports/table.txt | head -15 || true)

    comment_body="{
      \"comments\": [
        {
          \"parentCommentId\": 0,
          \"content\": \"${status}\n\n**ðŸ” Lint Summary:**\n\`\`\`\n${lint_details}\n\`\`\`\n\nðŸ“¦ [View Lint Report Artifact](${artifact_url})\",
          \"commentType\": 1
        }
      ],
      \"status\": 1
    }"

    echo "$comment_body" > body.json

    curl -s -X POST \
      -H "Content-Type: application/json" \
      -H "Authorization: Bearer $SYSTEM_ACCESSTOKEN" \
      -d @body.json \
      "${org_url}${project}/_apis/git/repositories/${repo_id}/pullRequests/${pr_id}/threads?api-version=6.0"
  displayName: "Comment Apigee Lint Status on PR"
  env:
    SYSTEM_ACCESSTOKEN: $(System.AccessToken)
  condition: always()
